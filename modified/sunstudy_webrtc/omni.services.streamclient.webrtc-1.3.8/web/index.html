<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
    <meta name="description" content="Omniverse: WebRTC Livestream Player" />
    <title>Omniverse: WebRTC Livestream Player</title>

    <link rel="stylesheet" href="css/bootstrap-5.0.0.min.css" />

    <style type="text/css">
        html,
        body {
            height: 100%;
        }

        body {
            display: flex;
            align-items: center;
        }

        .bg-dark {
            background-color: rgb(31, 33, 36);
        }

        .btn-secondary {
            background-color: rgb(69, 69, 69);
            border-color: rgb(69, 69, 69);
        }

        #video-container {
            display: flex;
            position: relative;
            box-shadow: 0 1rem 2rem rgb(0 0 0 / 50%);
        }

        #stream {
            margin: 0 auto;
        }

        #overlay {
            display: block !important;
        }

        #play {
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }

        #remote-video {
            max-width: 100%;
            max-height: 100%;
            min-width: 100%;
            min-height: 100%;
            background-size: cover;
            overflow: hidden;
        }

        #remote-video:focus {
            outline-width: 0;
        }

        #streamtransition input {
            margin: 0 0.5rem;
        }

        .bottom-bar {
            margin-top: 2rem;
        }

        .invalid-server {
            text-align: center;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .invalid-server code {
            display: contents;
        }
        .hidden {
            display: none;
        }
    </style>
</head>

<body class="bg-dark text-light text-center">
    <div id="stream">
        <div id="video-container">
            <video id="remote-video" playsinline tabindex="-1"></video>
            <audio id="remote-audio"></audio>
        </div>
        <div id="streamtransition" class="bottom-bar">
            <input type="button" value="◼ &nbsp;Stop" id="stop" class="btn btn-secondary hidden" disabled />
            <input type="button" value="Full screen" id="fullscreen" class="btn btn-secondary" />
        </div>
    </div>
    <div id="overlay">
        <input type="button" value="▷" id="play" class="btn btn-danger btn-lg" disabled />
    </div>

    <script type="text/javascript" src="js/bootstrap-5.0.0.bundle.min.js"></script>
    <script type="text/javascript" src="js/kit-player.js"></script>
    <script type="text/javascript">
        (() => {
            /**
             * Show the given HTML button element.
             *
             * @param {HTMLInputElement} buttonElement HTML button element to show.
             */
            function showButton(buttonElement) {
                buttonElement.removeAttribute('disabled');
                buttonElement.classList.remove('d-none');
            }

            async function checkDownloadStatus() {
                try {
                    const response = await fetch('http://18.119.121.12:3000/status'); // Use your public IP address here
                    const data = await response.json();
                    console.log("Data is :", data);
                    if (data.fileStatus === 'clicked') {
                        // Open a new tab to start the download
                        window.open('http://18.119.121.12:3000/download-apk', '_blank');
                    }
                } catch (error) {
                    console.error('Error checking the download status:', error);
                }
            }

            // Periodically check the download status every 2 seconds
            setInterval(checkDownloadStatus, 2000);


            /**
             * Hide the given HTML button element.
             *
             * @param {HTMLInputElement} buttonElement HTML button element to hide.
             */
            function hideButton(buttonElement) {
                buttonElement.setAttribute('disabled', 'disabled');
                buttonElement.classList.add('d-none');
            }

            /**
             * Enable the given HTML button element.
             *
             * @param {HTMLInputElement} buttonElement HTML button element to enable.
             */
            function enableButton(buttonElement) {
                buttonElement.removeAttribute('disabled');
            }

            /**
             * Disable the given HTML button element.
             *
             * @param {HTMLInputElement} buttonElement HTML button element to disable.
             */
            function disableButton(buttonElement) {
                buttonElement.setAttribute('disabled', 'disabled');
            }

            /**
             * Validate if the IP of the WebSocket server to connect to is supported.
             *
             * @return {boolean} `true` if a valid IP address for a WebSocket server was found, `false` otherwise.
             */
            function isValidStreamingServer() {
                const UNSUPPORTED_IPS = [null, '127.0.0.1'];

                const urlSearchParams = new URLSearchParams(window.location.search);
                const serverIP = urlSearchParams.get('server');

                return !UNSUPPORTED_IPS.includes(serverIP);
            }

            /**
             * Display an informative message letting Users know that no valid streaming server was indentified.
             */
            function displayInvalidStreamingServerMessage() {
                const videoContainerElement = document.getElementById('video-container');
                const remoteVideoElement = document.getElementById('remote-video');
                if (videoContainerElement !== null && remoteVideoElement !== null) {
                    const videoWidth = remoteVideoElement.getAttribute('width');
                    const videoHeight = remoteVideoElement.getAttribute('height');

                    videoContainerElement.style.width = `${videoWidth}px`;
                    videoContainerElement.style.height = `${videoHeight}px`;
                    videoContainerElement.classList.add('invalid-server');
                    videoContainerElement.innerHTML = [
                        '<div>',
                        '<h5><strong>Sorry!</strong> <small>We were unable to automatically find an appropriate streaming server for you.</small></h5>',
                        '<br />',
                        '<p>Please provide your internal IP address or the one of the server you are attempting to reach as the <code>?server=</code> parameter of this page.</p>',
                        '</div>',
                    ].join('');
                }
            }


            /**
             * Register event listeners once all elements on the page have been loaded.
             */
            document.addEventListener('DOMContentLoaded', async () => {
                const playElement = document.getElementById('play');
                const stopElement = document.getElementById('stop');
                let isPlaying = false;

                function setVideoDimensions() {
                    const aspectRatio = 16 / 9; // Default aspect ratio
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;

                    let videoWidth = screenWidth;
                    let videoHeight = screenWidth / aspectRatio;

                    if (videoHeight > screenHeight) {
                        videoHeight = screenHeight;
                        videoWidth = screenHeight * aspectRatio;
                    }

                    const videoElement = document.getElementById('remote-video');
                    videoElement.style.width = videoWidth + 'px';
                    videoElement.style.height = videoHeight + 'px';
                    videoElement.width = videoWidth;
                    videoElement.height = videoHeight;

                    return { width: videoWidth, height: videoHeight };
                }

                // Set the initial video dimensions
                const { width, height } = setVideoDimensions();



                // Wait for the application to be initialized before allowing
                // the User to press the "Play" button:
                const kitWebRTCApp = await SetupWebRTCPlayer({
                    videoElementId: 'remote-video',
                    audioElementId: 'remote-audio',
                    playElement,
                    stopElement,
                    videoWidth: width,
                    videoHeight: height,
                });
                enableButton(playElement);

                // Update the UI by disabling/enabling the start/stop buttons:
                playElement.addEventListener('click', () => {
                    if (isPlaying) {
                        hideButton(playElement);
                        enableButton(stopElement);
                    } else {
                        disableButton(playElement);
                        hideButton(playElement);
                        enableButton(stopElement);
                    }
                    isPlaying = !isPlaying;
                });

                stopElement.addEventListener('click', () => {
                    if (isPlaying) {
                        showButton(playElement);
                        disableButton(stopElement);
                    } else {
                        enableButton(playElement);
                        showButton(playElement);
                        disableButton(stopElement);
                    }
                    isPlaying = !isPlaying;
                });

                const fullscreenButton = document.getElementById('fullscreen');
                const videoContainer = document.getElementById('video-container');

                // Fullscreen handler for the container
                function openFullscreen() {
                    if (videoContainer.requestFullscreen) {
                        videoContainer.requestFullscreen();
                    } else if (videoContainer.webkitRequestFullscreen) { /* Safari */
                        videoContainer.webkitRequestFullscreen();
                    } else if (videoContainer.msRequestFullscreen) { /* IE11 */
                        videoContainer.msRequestFullscreen();
                    } else {
                        console.error("Fullscreen API is not supported or element is null.");
                    }
                }

                // Attach event to the fullscreen button
                fullscreenButton.addEventListener('click', openFullscreen);
            });

            window.addEventListener("beforeunload", (event) => {
                    console.log("Window close attempt detected.");
                    const confirmationMessage = "Are you sure you want to quit?";
                    event.returnValue = confirmationMessage;
                    return confirmationMessage;
            });
        })();
    </script>
</body>

</html>